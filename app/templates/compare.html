{% extends "base.html" %}

{% block title %}Player Comparison - Bleuberry FC's MLS Fantasy Stats{% endblock %}

{% block header_title %}Player Comparison{% endblock %}

{% block content %}
<div class="main-container">
    <div class="content-wrapper">
        <!-- Modern Player Selection Section -->
        <div class="modern-card fade-in">
            <div class="modern-card-header">
                <i class="fas fa-balance-scale"></i>
                Select Players to Compare
            </div>
            <div class="modern-card-body">
                <div class="filters-grid mb-4">
                    <div class="filter-group">
                        <label class="filter-label" for="comparison-week-filter">Compare Data For</label>
                        <select class="form-select" id="comparison-week-filter" onchange="changeComparisonWeek()">
                            <option value="">Season Total</option>
                            {% for week in available_weeks %}
                            <option value="{{ week }}" {% if selected_week == week %}selected{% endif %}>{{ week }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="player-selection-grid">
                    <div class="player-input-group">
                        <label for="player1-search" class="player-label">
                            <i class="fas fa-user"></i> Player 1
                        </label>
                        <div class="search-container">
                            <input type="text" class="form-control player-search" id="player1-search" 
                                   placeholder="üîç Search for a player..." autocomplete="off" data-player-num="1">
                            <div class="search-results" id="player1-results"></div>
                        </div>
                    </div>
                    
                    <div class="player-input-group">
                        <label for="player2-search" class="player-label">
                            <i class="fas fa-user"></i> Player 2
                        </label>
                        <div class="search-container">
                            <input type="text" class="form-control player-search" id="player2-search" 
                                   placeholder="üîç Search for a player..." autocomplete="off" data-player-num="2">
                            <div class="search-results" id="player2-results"></div>
                        </div>
                    </div>
                </div>
                
                <div class="comparison-actions">
                    <button class="btn btn-primary" id="compare-btn" disabled>
                        <i class="fas fa-chart-line"></i> Compare Players
                    </button>
                    <button class="btn btn-outline-primary" id="add-player-btn">
                        <i class="fas fa-plus"></i> Add Player
                    </button>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Stats
                    </a>
                </div>
                
                <div id="additional-players" class="additional-players-container"></div>
            </div>
        </div>

        <!-- Modern Comparison Results Section -->
        <div class="modern-card slide-up" id="comparison-results" style="display: none;">
            <div class="modern-card-header">
                <i class="fas fa-trophy"></i>
                Comparison Results <span id="comparison-period-label" class="period-label"></span>
            </div>
            <div class="modern-card-body">
                <div class="comparison-table-container">
                    <table class="table comparison-table" id="comparison-table">
                        <thead>
                            <tr id="comparison-header">
                                <th class="stat-column">Statistic</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Modern Compare Page Styles */
.player-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    margin: 25px 0;
}

.player-input-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.player-label {
    font-weight: 600;
    color: var(--dark-text);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1rem;
}

.player-label i {
    color: var(--primary-color);
}

.search-container {
    position: relative;
}

.player-search {
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: var(--border-radius-sm);
    font-size: 0.95rem;
    transition: var(--transition);
}

.player-search:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}

.player-search.selected-player {
    background: linear-gradient(135deg, rgba(39, 174, 96, 0.1) 0%, rgba(46, 204, 113, 0.05) 100%);
    border-color: var(--success-color);
    color: var(--dark-text);
    font-weight: 600;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg-primary);
    border: 2px solid var(--accent-color);
    border-top: none;
    border-radius: 0 0 var(--border-radius-sm) var(--border-radius-sm);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: var(--shadow-medium);
}

.search-result-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f1f2f6;
    transition: var(--transition);
}

.search-result-item:hover {
    background: rgba(52, 152, 219, 0.1);
    transform: translateX(2px);
}

.search-result-item:last-child {
    border-bottom: none;
}

.comparison-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 25px;
    flex-wrap: wrap;
}

.additional-players-container {
    margin-top: 25px;
    padding-top: 25px;
    border-top: 2px solid #f1f2f6;
}

.additional-player-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 15px;
    align-items: end;
    margin-bottom: 15px;
    padding: 15px;
    background: var(--bg-secondary);
    border-radius: var(--border-radius-sm);
}

/* Comparison Results Styles */
.period-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 400;
}

.comparison-table-container {
    overflow-x: auto;
    border-radius: var(--border-radius-sm);
    border: 1px solid #e9ecef;
}

.comparison-table {
    margin: 0;
    border-collapse: separate;
    border-spacing: 0;
}

.comparison-table thead th {
    background: var(--gradient-primary);
    color: white;
    padding: 16px 12px;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    border: none;
    position: sticky;
    top: 0;
    z-index: 5;
}

.comparison-table thead th:first-child {
    border-top-left-radius: var(--border-radius-sm);
}

.comparison-table thead th:last-child {
    border-top-right-radius: var(--border-radius-sm);
}

.comparison-table tbody td {
    padding: 14px 12px;
    border-bottom: 1px solid #f1f2f6;
    font-size: 0.9rem;
    vertical-align: middle;
    transition: var(--transition);
}

.comparison-table tbody tr:hover {
    background-color: rgba(52, 152, 219, 0.05);
}

.stat-column {
    font-weight: 600;
    color: var(--dark-text);
    background: var(--bg-secondary) !important;
    position: sticky;
    left: 0;
    z-index: 4;
    min-width: 150px;
}

.winner-cell {
    background: linear-gradient(135deg, rgba(39, 174, 96, 0.2) 0%, rgba(46, 204, 113, 0.1) 100%) !important;
    color: var(--success-color) !important;
    font-weight: 700;
    border-left: 4px solid var(--success-color);
    position: relative;
}

.winner-cell::before {
    content: "üèÜ";
    position: absolute;
    left: -2px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8em;
}

/* Player header cells */
.comparison-table thead .player-header {
    text-align: center;
    min-width: 140px;
}

.player-name {
    font-weight: 700;
    display: block;
    margin-bottom: 2px;
}

.player-team {
    font-size: 0.8em;
    opacity: 0.9;
    font-weight: 400;
}

/* Dark mode adjustments */
body.dark-mode .search-results {
    background: var(--bg-secondary);
    border-color: var(--accent-color);
}

body.dark-mode .search-result-item:hover {
    background: rgba(52, 152, 219, 0.2);
}

body.dark-mode .additional-player-row {
    background: var(--bg-tertiary);
}

body.dark-mode .comparison-table tbody tr:hover {
    background-color: rgba(52, 152, 219, 0.1);
}

/* Responsive design */
@media (max-width: 768px) {
    .player-selection-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .comparison-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .comparison-actions .btn {
        width: 100%;
        margin-bottom: 8px;
    }
    
    .additional-player-row {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .comparison-table thead th,
    .comparison-table tbody td {
        padding: 10px 8px;
        font-size: 0.85rem;
    }
}

@media (max-width: 576px) {
    .player-selection-grid {
        gap: 15px;
    }
    
    .player-search {
        padding: 10px 12px;
        font-size: 0.9rem;
    }
    
    .search-result-item {
        padding: 10px 12px;
        font-size: 0.9rem;
    }
    
    .comparison-table {
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let playerCount = 2;
let comparisonData = null;
let playersData = {{ data | tojson }};
let selectedPlayers = {};

function checkSelections() {
    const selectedCount = Object.keys(selectedPlayers).length;
    const compareBtn = document.getElementById('compare-btn');
    if (compareBtn) {
        compareBtn.disabled = selectedCount < 1;
    }
}

function getSelectedPlayers() {
    return Object.values(selectedPlayers);
}

document.addEventListener('DOMContentLoaded', function() {
    const compareBtn = document.getElementById('compare-btn');
    const addPlayerBtn = document.getElementById('add-player-btn');

    // Setup search functionality for initial players
    setupPlayerSearch('player1-search', 1);
    setupPlayerSearch('player2-search', 2);
    
    // Restore previously selected players from URL
    restoreSelectedPlayers();
    
    // Auto-compare if we have players restored and results were previously shown
    setTimeout(function() {
        console.log('Auto-compare check:', Object.keys(selectedPlayers).length, 'selected players');
        console.log('Selected players:', selectedPlayers);
        console.log('Compare button state:', compareBtn.disabled ? 'DISABLED' : 'ENABLED');
        if (Object.keys(selectedPlayers).length >= 1) {
            console.log('Auto-triggering comparison');
            if (compareBtn.disabled) {
                console.log('Button is disabled, forcing enable and triggering');
                compareBtn.disabled = false;
            }
            
            // Instead of clicking, directly call the comparison logic
            const selectedPlayerIds = getSelectedPlayers();
            console.log('Selected player IDs for comparison:', selectedPlayerIds);
            
            if (selectedPlayerIds.length >= 1) {
                const params = new URLSearchParams();
                selectedPlayerIds.forEach(playerId => {
                    params.append('players', playerId);
                });
                
                // Add week parameter if selected
                const selectedWeek = document.getElementById('comparison-week-filter').value;
                if (selectedWeek) {
                    params.append('week', selectedWeek);
                }
                
                console.log('Making auto API call to:', `/api/compare?${params.toString()}`);
                fetch(`/api/compare?${params.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Auto API response:', data);
                        if (data.error) {
                            console.error('Auto API error:', data.error);
                            return;
                        }
                        console.log('Auto calling displayComparison with:', data);
                        displayComparison(data);
                    })
                    .catch(error => {
                        console.error('Auto fetch error:', error);
                    });
            }
        } else {
            console.log('No players selected for auto-compare');
        }
    }, 500); // Increased delay to ensure restoration is complete

    function setupPlayerSearch(inputId, playerNum) {
        const input = document.getElementById(inputId);
        const resultsDiv = document.getElementById(`player${playerNum}-results`);
        
        input.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            
            if (query.length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const matches = playersData.filter(player => 
                player.Name.toLowerCase().includes(query) || 
                player.Team.toLowerCase().includes(query)
            ).slice(0, 10); // Limit to 10 results
            
            displaySearchResults(resultsDiv, matches, input, playerNum);
        });
        
        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });
    }

    function displaySearchResults(resultsDiv, matches, input, playerNum) {
        if (matches.length === 0) {
            resultsDiv.innerHTML = '<div class="search-result-item">No players found</div>';
            resultsDiv.style.display = 'block';
            return;
        }
        
        resultsDiv.innerHTML = matches.map(player => 
            `<div class="search-result-item" data-player-id="${player['Player ID']}" data-player-name="${player.Name}">
                <strong>${player.Name}</strong><br>
                <small class="text-muted">${player.Team} - ${player.Positions}</small>
            </div>`
        ).join('');
        
        // Add click handlers for results
        resultsDiv.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', function() {
                const playerId = this.dataset.playerId;
                const playerName = this.dataset.playerName;
                
                input.value = playerName;
                input.classList.add('selected-player');
                selectedPlayers[`player${playerNum}`] = playerId;
                resultsDiv.style.display = 'none';
                checkSelections();
            });
        });
        
        resultsDiv.style.display = 'block';
    }

    addPlayerBtn.addEventListener('click', function() {
        if (playerCount >= 4) return; // Limit to 4 players max
        
        playerCount++;
        const additionalPlayersDiv = document.getElementById('additional-players');
        
        const newPlayerDiv = document.createElement('div');
        newPlayerDiv.className = 'additional-player-row';
        newPlayerDiv.innerHTML = `
            <div class="player-input-group">
                <label for="player${playerCount}-search" class="player-label">
                    <i class="fas fa-user"></i> Player ${playerCount}
                </label>
                <div class="search-container">
                    <input type="text" class="form-control player-search additional-player-search" 
                           id="player${playerCount}-search" placeholder="üîç Search for a player..." 
                           autocomplete="off" data-player-num="${playerCount}">
                    <div class="search-results" id="player${playerCount}-results"></div>
                </div>
            </div>
            <div class="remove-action">
                <button class="btn btn-outline-danger remove-player-btn">
                    <i class="fas fa-times"></i> Remove
                </button>
            </div>
        `;
        
        additionalPlayersDiv.appendChild(newPlayerDiv);
        
        // Setup search for new player
        setupPlayerSearch(`player${playerCount}-search`, playerCount);
        
        // Add remove button handler
        const removeBtn = newPlayerDiv.querySelector('.remove-player-btn');
        removeBtn.addEventListener('click', function() {
            delete selectedPlayers[`player${playerCount}`];
            newPlayerDiv.remove();
            checkSelections();
            if (playerCount < 4) {
                addPlayerBtn.style.display = 'inline-block';
            }
        });
        
        if (playerCount >= 4) {
            addPlayerBtn.style.display = 'none';
        }
    });

    compareBtn.addEventListener('click', function() {
        const selectedPlayerIds = getSelectedPlayers();
        if (selectedPlayerIds.length < 2) return;
        
        const params = new URLSearchParams();
        selectedPlayerIds.forEach(playerId => {
            params.append('players', playerId);
        });
        
        // Add week parameter if selected
        const selectedWeek = document.getElementById('comparison-week-filter').value;
        if (selectedWeek) {
            params.append('week', selectedWeek);
        }
        
        console.log('Making API call to:', `/api/compare?${params.toString()}`);
        fetch(`/api/compare?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                console.log('API response:', data);
                if (data.error) {
                    console.error('API error:', data.error);
                    alert(data.error);
                    return;
                }
                console.log('Calling displayComparison with:', data);
                displayComparison(data);
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Error comparing players');
            });
    });
});

function displayComparison(data) {
    comparisonData = data;
    const resultsDiv = document.getElementById('comparison-results');
    const header = document.getElementById('comparison-header');
    const body = document.getElementById('comparison-body');
    const periodLabel = document.getElementById('comparison-period-label');
    
    // Update period label
    if (data.week) {
        periodLabel.textContent = `(${data.week})`;
    } else {
        periodLabel.textContent = '';
    }
    
    // Clear existing content
    header.innerHTML = '<th class="stat-column">Statistic</th>';
    body.innerHTML = '';
    
    // Add player headers
    data.players.forEach(player => {
        const th = document.createElement('th');
        th.className = 'player-header';
        th.innerHTML = `
            <span class="player-name">${player.Name}</span>
            <span class="player-team">${player.Team}</span>
        `;
        header.appendChild(th);
    });
    
    // Add stat rows
    data.stats.forEach(stat => {
        const row = document.createElement('tr');
        
        // Stat name
        const statCell = document.createElement('td');
        statCell.className = 'stat-column';
        // Use display name if available, otherwise use the original stat name
        const displayName = data.stat_display_names ? data.stat_display_names[stat] || stat : stat;
        statCell.textContent = displayName;
        row.appendChild(statCell);
        
        // Player values
        data.players.forEach(player => {
            const valueCell = document.createElement('td');
            valueCell.textContent = player[stat] || '0';
            
            // Highlight winner
            if (data.winner_stats[stat] === player['Player ID']) {
                valueCell.className = 'winner-cell';
            }
            
            row.appendChild(valueCell);
        });
        
        body.appendChild(row);
    });
    
    resultsDiv.style.display = 'block';
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
}

function changeComparisonWeek() {
    const weekSelect = document.getElementById('comparison-week-filter');
    const selectedWeek = weekSelect.value;
    
    // Build the URL with the week parameter
    const urlParams = new URLSearchParams(window.location.search);
    
    if (selectedWeek) {
        urlParams.set('week', selectedWeek);
    } else {
        urlParams.delete('week');
    }
    
    // Preserve currently selected player names
    const currentPlayerNames = [];
    for (let i = 1; i <= playerCount; i++) {
        const input = document.getElementById(`player${i}-search`);
        if (input && input.value && input.value.trim()) {
            // Extract just the player name if it contains "(not available this week)"
            const playerName = input.value.replace(' (not available this week)', '').trim();
            if (playerName) {
                currentPlayerNames.push(playerName);
            }
        }
    }
    
    // Add player names to URL if any are selected
    if (currentPlayerNames.length > 0) {
        urlParams.set('players', currentPlayerNames.join('|'));
    } else {
        urlParams.delete('players');
    }
    
    // Navigate to the new URL to reload with correct player data
    const newUrl = window.location.pathname + '?' + urlParams.toString();
    window.location.href = newUrl;
}

function restoreSelectedPlayers() {
    const urlParams = new URLSearchParams(window.location.search);
    const savedPlayers = urlParams.get('players');
    
    if (savedPlayers) {
        const playerNames = savedPlayers.split('|');
        
        // Add additional player fields if needed
        while (playerNames.length > playerCount) {
            document.getElementById('add-player-btn').click();
        }
        
        playerNames.forEach((playerName, index) => {
            const playerNum = index + 1;
            const input = document.getElementById(`player${playerNum}-search`);
            
            if (input && playerName.trim()) {
                // Find the player in the current week's data
                const matchingPlayer = playersData.find(player => 
                    player.Name.trim() === playerName.trim()
                );
                
                if (matchingPlayer) {
                    // Set the input value and mark as selected
                    input.value = playerName.trim();
                    input.classList.add('selected-player');
                    input.style.color = '';
                    selectedPlayers[`player${playerNum}`] = matchingPlayer['Player ID'];
                } else {
                    // Player not found in current week, show a message but keep for reference
                    input.value = playerName.trim() + ' (not available this week)';
                    input.style.color = '#999';
                    input.classList.remove('selected-player');
                    // Remove from selectedPlayers but keep the input visible
                    delete selectedPlayers[`player${playerNum}`];
                }
            }
        });
        
        // Update compare button state
        checkSelections();
        console.log('Final selectedPlayers object after restoration:', selectedPlayers);
    }
}
</script>
{% endblock %}